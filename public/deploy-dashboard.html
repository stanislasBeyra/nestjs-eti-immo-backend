<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline CI/CD Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pipeline-bg': '#f8f9fa',
                        'stage-success': '#d4edda',
                        'stage-pending': '#e2e6ea',
                        'commit-blue': '#007bff',
                        'text-muted': '#6c757d'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-pipeline-bg min-h-screen font-sans">
    <div class="container mx-auto p-6 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm mb-6 p-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">deployment view</h1>
            <div class="text-sm text-text-muted">
                Temps moyen des stages: 
                <span class="text-gray-700" id="avg-time-display">(Dur√©e compl√®te moyenne: ~3min 25s)</span>
            </div>
        </div>

        <!-- Pipeline Stages Header -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <!-- Stages Header -->
            <div class="grid grid-cols-7 bg-gray-50 border-b">
                <div class="p-4 text-center font-semibold text-gray-700">date deploiement</div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>git Syncro:</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>Dependencies</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>Build</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>Nettoyage</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>Red√©marrage</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>temps total</div>
                </div>
            </div>

            <!-- Pipeline Rows -->
            <div class="divide-y" id="pipeline-rows">
                <!-- Les lignes seront g√©n√©r√©es dynamiquement -->
            </div>
        </div>

        <!-- Footer Stats -->
        <div class="mt-6 grid grid-cols-3 gap-4">
            <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="success-rate">100%</div>
                <div class="text-sm text-text-muted">Taux de succ√®s</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="avg-duration">~3m 25s</div>
                <div class="text-sm text-text-muted">Dur√©e moyenne</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="total-pipelines">5</div>
                <div class="text-sm text-text-muted">Pipelines r√©cents</div>
            </div>
        </div>
    </div>

    <script>
        class PipelineDashboard {
            constructor() {
                this.init();
            }

            init() {
                console.log('üöÄ Initialisation du dashboard...');
                this.loadData();
            }

            async loadData() {
                console.log('üîÑ Chargement des donn√©es...');
                
                try {
                    const response = await fetch('https://immo.partenairesmtn.ci/api/deploy/history');
                    
                    if (response.ok) {
                        const deployments = await response.json();
                        console.log('üìö Donn√©es re√ßues:', deployments);
                        this.updateDisplay(deployments);
                    } else {
                        console.error('‚ùå Erreur:', response.status);
                        this.showError(`Erreur ${response.status}`);
                    }

                } catch (error) {
                    console.error('‚ùå Erreur de connexion:', error);
                    this.showError('Erreur de connexion');
                }
            }

            updateDisplay(deployments) {
                if (!deployments || deployments.length === 0) {
                    document.getElementById('pipeline-rows').innerHTML = `
                        <div class="p-8 text-center text-gray-500">Aucun d√©ploiement trouv√©</div>
                    `;
                    return;
                }

                // Trier par date (plus r√©cent en premier)
                const sortedDeployments = [...deployments].sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                // G√©n√©rer les lignes
                const rowsHTML = sortedDeployments.map((deployment) => {
                    const date = new Date(deployment.created_at);
                    const dateStr = date.toLocaleDateString('fr-FR', { month: 'long', day: '2-digit' });
                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    const commit = deployment.commit_hash ? deployment.commit_hash.slice(0, 20) : 'N/A';
                    const branch = deployment.branch ? deployment.branch : 'N/A';

                    // Cr√©er une cellule d'√©tape simple
                    const createStageCell = (duration, isLongest = false) => {
                        const progressBar = isLongest ? '<div class="absolute top-0 left-0 bg-blue-500 h-1 w-3/4 rounded-t-lg"></div>' : '';
                        return `
                            <div class="p-4 border-l flex items-center justify-center">
                                <div class="bg-stage-success rounded-lg p-6 w-full text-center border border-green-200 relative">
                                    <div class="font-medium text-green-800">${this.formatDuration(duration)}</div>
                                    ${progressBar}
                                </div>
                            </div>
                        `;
                    };

                    // D√©terminer les √©tapes les plus longues pour la barre de progression
                    const times = [deployment.pulling_time, deployment.installing_time, deployment.building_time, deployment.cleaning_time, deployment.restarting_time];
                    const maxTime = Math.max(...times);

                    return `
                        <div class="grid grid-cols-7 hover:bg-gray-50 transition-colors duration-200">
                            <div class="p-4 flex items-center justify-center">
                                <div class="flex items-center gap-3">
                                    <div class="text-center">
                                        <div class="text-xs text-text-muted">${dateStr}</div>
                                        <div class="text-xs text-text-muted">${timeStr}</div>
                                    </div>
                                    <div class="bg-gray-500 text-white px-3 py-2 rounded text-sm font-medium">
                                        <div class="text-xs">${branch}</div>
                                        <div class="text-xs">${commit}</div>
                                    </div>
                                </div>
                            </div>
                            ${createStageCell(deployment.pulling_time)}
                            ${createStageCell(deployment.installing_time)}
                            ${createStageCell(deployment.building_time, deployment.building_time === maxTime)}
                            ${createStageCell(deployment.cleaning_time)}
                            ${createStageCell(deployment.restarting_time, deployment.restarting_time === maxTime)}
                            ${createStageCell(deployment.total_time)}
                        </div>
                    `;
                }).join('');

                document.getElementById('pipeline-rows').innerHTML = rowsHTML;
                this.updateStats(deployments);
                this.updateHeader(deployments);
                this.animateRows();
            }

            updateHeader(deployments) {
                if (deployments.length === 0) return;

                // Calculer seulement la moyenne totale pour l'affichage principal
                const avgTotal = Math.round(deployments.reduce((sum, d) => sum + d.total_time, 0) / deployments.length);
                document.getElementById('avg-time-display').textContent = `(Dur√©e compl√®te moyenne: ${this.formatDuration(avgTotal)})`;
            }

            updateStats(deployments) {
                const successCount = deployments.filter(d => d.final_status === 'success').length;
                const successRate = Math.round((successCount / deployments.length) * 100);
                const avgDuration = Math.round(deployments.reduce((sum, d) => sum + d.total_time, 0) / deployments.length);
                
                document.getElementById('success-rate').textContent = `${successRate}%`;
                document.getElementById('avg-duration').textContent = `~${this.formatDuration(avgDuration)}`;
                document.getElementById('total-pipelines').textContent = deployments.length;
            }

            formatDuration(seconds) {
                if (!seconds || seconds === 0) return '0s';
                if (seconds < 60) return `${seconds}s`;
                
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                if (remainingSeconds === 0) {
                    return `${minutes}min`;
                }
                return `${minutes}min ${remainingSeconds}s`;
            }

            showError(message) {
                document.getElementById('pipeline-rows').innerHTML = `
                    <div class="p-8 text-center text-red-500">${message}</div>
                `;
            }

            animateRows() {
                const rows = document.querySelectorAll('.grid.grid-cols-7:not(.bg-gray-50)');
                rows.forEach((row, index) => {
                    row.style.opacity = '0';
                    row.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        row.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                        row.style.opacity = '1';
                        row.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            }
        }

        // Initialiser le dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new PipelineDashboard();
        });

        // Effets hover simples
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('mouseover', function(e) {
                if (e.target.closest('.bg-stage-success')) {
                    const stage = e.target.closest('.bg-stage-success');
                    stage.style.transform = 'scale(1.02)';
                    stage.style.transition = 'transform 0.2s ease';
                }
            });
            
            document.addEventListener('mouseout', function(e) {
                if (e.target.closest('.bg-stage-success')) {
                    const stage = e.target.closest('.bg-stage-success');
                    stage.style.transform = 'scale(1)';
                }
            });
        });
    </script>
</body>
</html>