<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline CI/CD Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pipeline-bg': '#f8f9fa',
                        'stage-success': '#d4edda',
                        'stage-pending': '#e2e6ea',
                        'commit-blue': '#007bff',
                        'text-muted': '#6c757d'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-pipeline-bg min-h-screen font-sans">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm mb-6 p-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">deployment view</h1>
            <div class="text-sm text-text-muted">
                Temps moyen des stages: 
                <span class="text-gray-700">(Dur√©e compl√®te moyenne: ~3min 25s)</span>
            </div>
        </div>

        <!-- Pipeline Stages Header -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <!-- Stages Header -->
            <div class="grid grid-cols-7 bg-gray-50 border-b">
                <div class="p-4 text-center font-semibold text-gray-700">date deploiement</div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>git Syncro:</div>
                    <div class="text-xs text-text-muted mt-1" id="header-git">--</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>Dependencies</div>
                    <div class="text-xs text-text-muted mt-1" id="header-deps">--</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>Build</div>
                    <div class="text-xs text-text-muted mt-1" id="header-build">--</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>Nettoyage</div>
                    <div class="text-xs text-text-muted mt-1" id="header-clean">--</div>
                </div>
                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>Red√©marrage</div>
                    <div class="text-xs text-text-muted mt-1" id="header-restart">--</div>
                </div>

                <div class="p-4 text-center font-semibold text-gray-700 border-l">
                    <div>temps total</div>
                    <div class="text-xs text-text-muted mt-1" id="header-total">--</div>
                </div>
                
            </div>

            <!-- Pipeline Rows -->
            <div class="divide-y" id="pipeline-rows">
                <!-- Les lignes de d√©ploiement seront g√©n√©r√©es dynamiquement ici -->
            </div>
        </div>

        <!-- Footer Stats -->
        <div class="mt-6 grid grid-cols-3 gap-4">
            <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="success-rate">--</div>
                <div class="text-sm text-text-muted">Taux de succ√®s</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="avg-duration">--</div>
                <div class="text-sm text-text-muted">Dur√©e moyenne</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="total-pipelines">--</div>
                <div class="text-sm text-text-muted">Pipelines r√©cents</div>
            </div>
        </div>

        <!-- Contr√¥les -->
        <div class="mt-6 bg-white rounded-lg shadow-sm p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button id="refresh-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        üîÑ Actualiser
                    </button>
                    <button id="clear-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        üóëÔ∏è Effacer
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="auto-refresh" checked class="w-4 h-4">
                    <label for="auto-refresh" class="text-sm text-gray-600">Actualisation automatique</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PipelineDashboard {
            constructor() {
                this.autoRefreshInterval = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadData();
                this.startAutoRefresh();
            }

            setupEventListeners() {
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.loadData();
                });

                document.getElementById('clear-btn').addEventListener('click', () => {
                    this.clearData();
                });

                document.getElementById('auto-refresh').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                });
            }

            async loadData() {
                try {
                    // Charger l'historique des d√©ploiements
                    const historyResponse = await fetch('/api/deploy/history');
                    if (historyResponse.ok) {
                        const history = await historyResponse.json();
                        this.updatePipelineRows(history);
                    }

                    // Charger les dur√©es actuelles
                    const durationsResponse = await fetch('/api/deploy/durations');
                    if (durationsResponse.ok) {
                        const durations = await durationsResponse.json();
                        this.updateHeaderDurations(durations);
                    }

                    // Charger le statut actuel
                    const statusResponse = await fetch('/api/deploy/status');
                    if (statusResponse.ok) {
                        const status = await statusResponse.json();
                        this.updateCurrentStatus(status);
                    }

                } catch (error) {
                    console.error('Erreur lors du chargement des donn√©es:', error);
                }
            }

            updatePipelineRows(history) {
                const container = document.getElementById('pipeline-rows');
                
                if (!history.deployments || history.deployments.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">Aucun d√©ploiement dans l\'historique</div>';
                    return;
                }

                const rowsHTML = history.deployments.map(deployment => {
                    const date = new Date(deployment.timestamp);
                    const dateStr = date.toLocaleDateString('fr-FR', { month: 'long', day: '2-digit' });
                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    // Simuler des dur√©es pour l'instant (√† remplacer par les vraies donn√©es)
                    const gitDuration = this.formatDuration(Math.floor(Math.random() * 5) + 1);
                    const depsDuration = this.formatDuration(Math.floor(Math.random() * 10) + 1);
                    const buildDuration = this.formatDuration(Math.floor(Math.random() * 120) + 30);
                    const cleanDuration = this.formatDuration(Math.floor(Math.random() * 15) + 5);
                    const restartDuration = this.formatDuration(Math.floor(Math.random() * 60) + 20);
                    
                    const totalSeconds = this.parseDuration(gitDuration) + this.parseDuration(depsDuration) + 
                                      this.parseDuration(buildDuration) + this.parseDuration(cleanDuration) + 
                                      this.parseDuration(restartDuration);
                    const totalDuration = this.formatDuration(totalSeconds);

                    return `
                        <div class="grid grid-cols-7 hover:bg-gray-50 transition-colors duration-200">
                            <div class="p-4 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-xs text-text-muted">${dateStr}</div>
                                    <div class="text-xs text-text-muted">${timeStr}</div>
                                    <div class="inline-block bg-gray-600 text-white px-2 py-1 rounded text-xs mt-2">${deployment.commit || 'N/A'}</div>
                                </div>
                            </div>
                            <div class="p-4 border-l flex items-center justify-center">
                                <div class="bg-stage-success rounded-lg p-6 w-full text-center border border-green-200">
                                    <div class="font-medium text-green-800">${gitDuration}</div>
                                </div>
                            </div>
                            <div class="p-4 border-l flex items-center justify-center">
                                <div class="bg-stage-success rounded-lg p-6 w-full text-center border border-green-200">
                                    <div class="font-medium text-green-800">${depsDuration}</div>
                                </div>
                            </div>
                            <div class="p-4 border-l flex items-center justify-center">
                                <div class="bg-stage-success rounded-lg p-6 w-full text-center border border-green-200 relative">
                                    <div class="font-medium text-green-800">${buildDuration}</div>
                                    <div class="absolute top-0 left-0 bg-blue-500 h-1 w-3/4 rounded-t-lg"></div>
                                </div>
                            </div>
                            <div class="p-4 border-l flex items-center justify-center">
                                <div class="bg-stage-success rounded-lg p-6 w-full text-center border border-green-200">
                                    <div class="font-medium text-green-800">${cleanDuration}</div>
                                </div>
                            </div>
                            <div class="p-4 border-l flex items-center justify-center">
                                <div class="bg-stage-success rounded-lg p-6 w-full text-center border border-green-200 relative">
                                    <div class="font-medium text-green-800">${restartDuration}</div>
                                    <div class="absolute top-0 left-0 bg-blue-500 h-1 w-4/5 rounded-t-lg"></div>
                                </div>
                            </div>
                            <div class="p-4 border-l flex items-center justify-center">
                                <div class="bg-stage-success rounded-lg p-6 w-full text-center border border-green-200">
                                    <div class="font-medium text-green-800">${totalDuration}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = rowsHTML;
                this.updateStats(history.deployments);
                this.animateRows();
            }

            updateHeaderDurations(durations) {
                if (durations.durations) {
                    document.getElementById('header-git').textContent = this.formatDuration(durations.durations.git);
                    document.getElementById('header-deps').textContent = this.formatDuration(durations.durations.dependencies);
                    document.getElementById('header-build').textContent = this.formatDuration(durations.durations.build);
                    document.getElementById('header-clean').textContent = this.formatDuration(durations.durations.clean);
                    document.getElementById('header-restart').textContent = this.formatDuration(durations.durations.restart);
                    
                    const total = durations.durations.git + durations.durations.dependencies + 
                                durations.durations.build + durations.durations.clean + durations.durations.restart;
                    document.getElementById('header-total').textContent = this.formatDuration(total);
                }
            }

            updateCurrentStatus(status) {
                // Mettre √† jour le statut actuel si n√©cessaire
                console.log('Statut actuel:', status);
            }

            updateStats(deployments) {
                const successCount = deployments.filter(d => d.status === 'success').length;
                const successRate = deployments.length > 0 ? Math.round((successCount / deployments.length) * 100) : 0;
                
                document.getElementById('success-rate').textContent = `${successRate}%`;
                document.getElementById('total-pipelines').textContent = deployments.length;
                
                // Calculer la dur√©e moyenne (simulation pour l'instant)
                document.getElementById('avg-duration').textContent = '~3m 25s';
            }

            formatDuration(seconds) {
                if (seconds === 0) return '--';
                if (seconds < 60) return `${seconds}s`;
                if (seconds < 3600) {
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    return `${minutes}min ${remainingSeconds}s`;
                }
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${minutes}min`;
            }

            parseDuration(durationStr) {
                if (durationStr === '--') return 0;
                if (durationStr.includes('h')) {
                    const [hours, minutes] = durationStr.split('h ');
                    return parseInt(hours) * 3600 + parseInt(minutes.replace('min', '')) * 60;
                }
                if (durationStr.includes('min')) {
                    const [minutes, seconds] = durationStr.split('min ');
                    return parseInt(minutes) * 60 + parseInt(seconds.replace('s', ''));
                }
                return parseInt(durationStr.replace('s', ''));
            }

            clearData() {
                document.getElementById('pipeline-rows').innerHTML = '<div class="p-8 text-center text-gray-500">Donn√©es effac√©es</div>';
                document.getElementById('success-rate').textContent = '--';
                document.getElementById('avg-duration').textContent = '--';
                document.getElementById('total-pipelines').textContent = '--';
            }

            animateRows() {
                const rows = document.querySelectorAll('.grid.grid-cols-7:not(.bg-gray-50)');
                rows.forEach((row, index) => {
                    row.style.opacity = '0';
                    row.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        row.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                        row.style.opacity = '1';
                        row.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            }

            startAutoRefresh() {
                this.stopAutoRefresh();
                this.autoRefreshInterval = setInterval(() => {
                    this.loadData();
                }, 10000); // Actualisation toutes les 10 secondes
            }

            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                }
            }
        }

        // Initialiser le dashboard quand la page est charg√©e
        document.addEventListener('DOMContentLoaded', () => {
            new PipelineDashboard();
        });

        // Effet hover sur les stages
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('mouseover', function(e) {
                if (e.target.closest('.bg-stage-success')) {
                    const stage = e.target.closest('.bg-stage-success');
                    stage.style.transform = 'scale(1.02)';
                    stage.style.transition = 'transform 0.2s ease';
                }
            });
            
            document.addEventListener('mouseout', function(e) {
                if (e.target.closest('.bg-stage-success')) {
                    const stage = e.target.closest('.bg-stage-success');
                    stage.style.transform = 'scale(1)';
                }
            });
        });
    </script>
</body>
</html>
